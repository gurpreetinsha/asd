<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Bus Collector - TheRoadApp</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #121212; color: #f5f5f5; }
    button { padding: 14px 20px; border: none; border-radius: 8px; margin-top: 20px; cursor: pointer; font-weight: bold; }
    #start { background: #007BFF; color: #fff; }
    #stop { background: #dc3545; color: #fff; display: none; }
    #log { margin-top: 20px; font-size: 0.9rem; white-space: pre-wrap; background:#1e1e1e; padding:10px; border-radius:8px; }
  </style>
</head>
<body>
  <h1>🚌 Bus Data Collector</h1>
  <p>This app captures GPS + accelerometer data and sends it to Supabase.</p>
  <button id="start">Start Collecting</button>
  <button id="stop">Stop</button>
  <div id="log">Idle...</div>

  <script type="module">
    // === Supabase Config ===
    const SUPABASE_URL = "https://jnjhkmlvfmynxyjypyie.supabase.co";
    const API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpuamhrbWx2Zm15bnh5anlweWllIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyNTA4MjMsImV4cCI6MjA3MzgyNjgyM30.Xp1Y3UvqQhbuxP3KV_1dtW8Zff-yy0fA94G5O3wecOo";

    let collecting = false;
    let watchId = null;
    let motionData = { x:0, y:0, z:0 };

    // Accelerometer
    window.addEventListener("devicemotion", (event) => {
      if (event.accelerationIncludingGravity) {
        motionData = {
          x: event.accelerationIncludingGravity.x || 0,
          y: event.accelerationIncludingGravity.y || 0,
          z: event.accelerationIncludingGravity.z || 0,
        };
      }
    });

    // Start
    document.getElementById("start").onclick = () => {
      collecting = true;
      document.getElementById("start").style.display = "none";
      document.getElementById("stop").style.display = "inline-block";
      document.getElementById("log").textContent = "Collecting data...";

      watchId = navigator.geolocation.watchPosition(async (pos) => {
        if (!collecting) return;

        const payload = {
          latitude: pos.coords.latitude,
          longitude: pos.coords.longitude,
          speed: pos.coords.speed || 0,
          accel_x: motionData.x,
          accel_y: motionData.y,
          accel_z: motionData.z,
          collected_at: new Date().toISOString(),
          source: "bus"
        };

        try {
          const res = await fetch(`${SUPABASE_URL}/rest/v1/road_data`, {
            method: "POST",
            headers: {
              apikey: API_KEY,
              Authorization: `Bearer ${API_KEY}`,
              "Content-Type": "application/json",
              Prefer: "return=minimal"
            },
            body: JSON.stringify(payload)
          });

          if (res.ok) {
            document.getElementById("log").textContent =
              `Sent:\n${JSON.stringify(payload, null, 2)}`;
          } else {
            document.getElementById("log").textContent = "❌ Error: " + await res.text();
          }
        } catch (err) {
          document.getElementById("log").textContent = "❌ Error: " + err.message;
        }
      }, (err) => {
        alert("GPS error: " + err.message);
      }, { enableHighAccuracy: true });
    };

    // Stop
    document.getElementById("stop").onclick = () => {
      collecting = false;
      if (watchId) navigator.geolocation.clearWatch(watchId);
      document.getElementById("start").style.display = "inline-block";
      document.getElementById("stop").style.display = "none";
      document.getElementById("log").textContent = "Stopped.";
    };
  </script>
</body>
</html>
